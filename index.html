<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Golden Magic Christmas Tree</title>

<style>
body {
    margin: 0;
    background: #000;
    overflow: hidden;
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto;
}
#hint {
    position: fixed;
    top: 20px;
    width: 100%;
    text-align: center;
    color: #d4af37;
    z-index: 10;
    letter-spacing: 2px;
}
#start {
    position: fixed;
    inset: 0;
    background: #000;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 100;
}
#start button {
    padding: 18px 36px;
    font-size: 18px;
    border-radius: 30px;
    border: none;
    background: #d4af37;
    cursor: pointer;
}
#video {
    position: fixed;
    right: 20px;
    top: 20px;
    width: 160px;
    border: 1px solid #d4af37;
    border-radius: 8px;
    transform: scaleX(-1);
    z-index: 20;
}
</style>
</head>

<body>

<div id="start"><button>ğŸ¥ å¯åŠ¨æ‘„åƒå¤´</button></div>
<div id="hint">ç­‰å¾…å¯åŠ¨â€¦</div>
<video id="video" autoplay muted playsinline></video>

<script type="importmap">
{
  "imports": {
    "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { gsap } from 'https://cdn.skypack.dev/gsap';

let scene, camera, renderer, composer;
let tree, lights, star;
let openness = 0;
const COUNT = 1200;

initThree();
animate();

/* ---------- Three.js ---------- */
function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(45, innerWidth/innerHeight, 0.1, 200);
    camera.position.set(0, 6, 35);

    renderer = new THREE.WebGLRenderer({ antialias:true });
    renderer.setSize(innerWidth, innerHeight);
    renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
    document.body.appendChild(renderer.domElement);

    composer = new EffectComposer(renderer);
    composer.addPass(new RenderPass(scene, camera));
    composer.addPass(new UnrealBloomPass(
        new THREE.Vector2(innerWidth, innerHeight),
        1.4, 0.6, 0.1
    ));

    scene.add(new THREE.AmbientLight(0xffffff, 0.6));

    createTree();
    createLights();
    createStar();

    window.addEventListener('resize', () => {
        camera.aspect = innerWidth/innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(innerWidth, innerHeight);
        composer.setSize(innerWidth, innerHeight);
    });
}

function createTree() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    const col = [];

    for(let i=0;i<COUNT;i++){
        const t = Math.random();
        const r = (1 - t) * 6;
        const a = Math.random() * Math.PI * 2;
        pos.push(Math.cos(a)*r, t*18-9, Math.sin(a)*r);
        col.push(0.1+0.2*Math.random(),0.6+0.3*Math.random(),0.2);
    }

    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    geo.setAttribute('color', new THREE.Float32BufferAttribute(col,3));

    tree = new THREE.Points(
        geo,
        new THREE.PointsMaterial({
            size: 0.15,
            vertexColors: true,
            transparent:true,
            opacity:0.85
        })
    );
    scene.add(tree);
}

function createLights() {
    const geo = new THREE.BufferGeometry();
    const pos = [];
    for(let i=0;i<200;i++){
        const t=Math.random(), r=(1-t)*5, a=Math.random()*Math.PI*2;
        pos.push(Math.cos(a)*r, t*16-8, Math.sin(a)*r);
    }
    geo.setAttribute('position', new THREE.Float32BufferAttribute(pos,3));
    lights = new THREE.Points(
        geo,
        new THREE.PointsMaterial({ color:0xffd700, size:0.25 })
    );
    scene.add(lights);
}

function createStar() {
    const geo = new THREE.SphereGeometry(0.6,16,16);
    const mat = new THREE.MeshBasicMaterial({ color:0xfff2b0 });
    star = new THREE.Mesh(geo,mat);
    star.position.y = 9.5;
    scene.add(star);
}

/* ---------- æ‰‹åŠ¿ ---------- */
async function initHand() {
    const Hands = window.Hands;
    const Camera = window.Camera;
    const video = document.getElementById('video');
    const hint = document.getElementById('hint');

    const hands = new Hands({
        locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
    });

    hands.setOptions({ maxNumHands:1 });

    hands.onResults(r=>{
        if(!r.multiHandLandmarks) return;
        const lm=r.multiHandLandmarks[0];
        const open = lm[8].y < lm[6].y && lm[12].y < lm[10].y;
        gsap.to({v:openness},{
            v:open?1:0,
            duration:0.8,
            onUpdate(){openness=this.targets()[0].v;}
        });
        hint.innerText=open?"ğŸ–ï¸ Merry Christmas":"âœŠ Hold";
    });

    const cam=new Camera(video,{
        onFrame:async()=>hands.send({image:video}),
        width:640,height:480
    });
    await cam.start();
}

/* ---------- åŠ¨ç”» ---------- */
function animate(t=0){
    requestAnimationFrame(animate);

    const s = 1 + openness*0.35;
    tree.scale.set(s,1+openness*0.2,s);
    lights.material.opacity = 0.6 + Math.sin(t*0.002)*0.3;

    star.scale.setScalar(1 + Math.sin(t*0.004)*0.15);
    star.rotation.y += 0.01;

    composer.render();
}

/* ---------- å¯åŠ¨ ---------- */
const load = src => new Promise(r=>{
    const s=document.createElement('script');
    s.src=src; s.onload=r; document.head.appendChild(s);
});

Promise.all([
    load('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'),
    load('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js')
]).then(()=>{
    document.querySelector('#start button').onclick=()=>{
        document.getElementById('start').remove();
        initHand();
    };
});
</script>
</body>
</html>
