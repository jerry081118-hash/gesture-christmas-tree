<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Golden Xmas - Stable Vision</title>
    <style>
        body { margin: 0; background: #020508; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        #loading { position: fixed; inset: 0; background: #020508; color: #d4af37; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; transition: opacity 0.8s; }
        #upload-btn { position: fixed; bottom: 30px; left: 30px; background: #c41e3a; color: white; border: none; padding: 12px 25px; border-radius: 25px; cursor: pointer; z-index: 100; box-shadow: 0 4px 15px rgba(196,30,58,0.4); font-weight: bold; }
        #info-panel { position: fixed; top: 20px; width: 100%; text-align: center; color: #d4af37; pointer-events: none; z-index: 10; text-shadow: 0 0 8px rgba(0,0,0,0.8); }
        canvas { display: block; }
        /* é¢„è§ˆå°çª— */
        #video-canvas { position: fixed; bottom: 20px; right: 20px; width: 160px; height: 120px; border: 1px solid #d4af37; border-radius: 8px; transform: scaleX(-1); z-index: 50; background: #000; }
    </style>
</head>
<body>

<div id="loading">
    <div style="font-size: 24px; margin-bottom: 10px;">ğŸ„ æ­£åœ¨ç‚¹äº®åœ£è¯ä¹‹å…‰...</div>
    <div id="load-status">æ­£åœ¨åˆå§‹åŒ– 3D å¼•æ“...</div>
</div>

<div id="info-panel">
    <h2 style="letter-spacing: 4px; margin-bottom: 5px;">GOLDEN MAGIC TREE</h2>
    <div id="gesture-hint">æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...</div>
</div>

<button id="upload-btn" onclick="document.getElementById('input-file').click()">ğŸ ä¸Šä¼ ç…§ç‰‡</button>
<input type="file" id="input-file" hidden multiple accept="image/*">
<video id="webcam-video" playsinline style="display:none"></video>
<canvas id="video-canvas"></canvas>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { GSAP } from 'https://cdn.skypack.dev/gsap';

    let scene, camera, renderer, instMesh, treeGroup, snow;
    let isExploded = false;
    const PHOTO_NODES = [];
    const PARTICLE_COUNT = 800;

    // --- åˆå§‹åŒ–åœºæ™¯ ---
    async function init() {
        // 1. Three.js åŸºç¡€è®¾ç½®
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0x020508);
        scene.fog = new THREE.FogExp2(0x020508, 0.02);

        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(0, 5, 35);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.body.appendChild(renderer.domElement);

        const ambient = new THREE.AmbientLight(0xffffff, 0.6);
        const point = new THREE.PointLight(0xffd700, 2, 100);
        point.position.set(10, 20, 10);
        scene.add(ambient, point);

        createTree();
        createSnow();
        
        // 2. çª—å£è‡ªé€‚åº”
        window.addEventListener('resize', onWindowResize);

        // 3. å¯åŠ¨æ‰‹åŠ¿å¼•æ“ (æ ¸å¿ƒä¿®å¤å¤„)
        document.getElementById('load-status').innerText = "æ­£åœ¨æ¿€æ´» AI æ‰‹åŠ¿è¯†åˆ«...";
        initHandTracking();

        animate();
    }

    // --- å…·è±¡åœ£è¯æ ‘æ„å»º ---
    function createTree() {
        treeGroup = new THREE.Group();
        const geometry = new THREE.ConeGeometry(0.2, 0.5, 4);
        const material = new THREE.MeshStandardMaterial({ 
            color: 0xd4af37, 
            metalness: 0.9, 
            roughness: 0.1,
            emissive: 0x443300 
        });

        instMesh = new THREE.InstancedMesh(geometry, material, PARTICLE_COUNT);
        const dummy = new THREE.Object3D();

        for (let i = 0; i < PARTICLE_COUNT; i++) {
            const t = i / PARTICLE_COUNT;
            const angle = i * 0.4;
            const radius = (1 - t) * 8;
            const y = t * 20 - 10;

            dummy.position.set(Math.cos(angle) * radius, y, Math.sin(angle) * radius);
            dummy.rotation.set(Math.random(), angle, 0);
            dummy.scale.setScalar(Math.random() * 0.5 + 0.5);
            dummy.updateMatrix();
            instMesh.setMatrixAt(i, dummy.matrix);
        }
        treeGroup.add(instMesh);
        scene.add(treeGroup);
    }

    function createSnow() {
        const geo = new THREE.BufferGeometry();
        const pts = [];
        for(let i=0; i<1500; i++) pts.push((Math.random()-0.5)*80, Math.random()*40, (Math.random()-0.5)*80);
        geo.setAttribute('position', new THREE.Float32BufferAttribute(pts, 3));
        snow = new THREE.Points(geo, new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.6 }));
        scene.add(snow);
    }

    // --- æ ¸å¿ƒä¿®å¤ï¼šæ›´å¥å£®çš„ MediaPipe åˆå§‹åŒ– ---
    async function initHandTracking() {
        const video = document.getElementById('webcam-video');
        const canvas = document.getElementById('video-canvas');
        const ctx = canvas.getContext('2d');
        const hint = document.getElementById('gesture-hint');

        try {
            // ç¡®ä¿è„šæœ¬å·²åŠ è½½
            const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7 });

            hands.onResults((results) => {
                // åœ¨å°ç”»å¸ƒé¢„è§ˆæ‘„åƒå¤´ï¼Œç¡®è®¤æ˜¯å¦å¼€å¯
                ctx.save();
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(results.image, 0, 0, canvas.width, canvas.height);
                ctx.restore();

                if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                    const lm = results.multiHandLandmarks[0];
                    // é€»è¾‘åˆ¤å®šï¼šæ¯”è¾ƒæŒ‡å°–å’ŒæŒ‡æ ¹è·ç¦»
                    const isOpen = lm[8].y < lm[6].y && lm[12].y < lm[10].y; 
                    
                    if (isOpen && !isExploded) toggleEffect(true);
                    if (!isOpen && isExploded) toggleEffect(false);

                    hint.innerText = isOpen ? "ğŸ–ï¸ å·²ç»½æ”¾" : "âœŠ å·²åˆæ‹¢";
                    
                    // ç›¸æœºäº’åŠ¨
                    gsap.to(camera.position, {
                        x: (lm[9].x - 0.5) * -40,
                        y: -(lm[9].y - 0.5) * 20 + 5,
                        duration: 0.5
                    });
                    camera.lookAt(0, 0, 0);
                }
            });

            const cam = new Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 640, height: 480
            });
            
            await cam.start();
            hint.innerText = "æ‘„åƒå¤´å·²å°±ç»ªï¼Œå°è¯•ã€æ¡æ‹³ã€‘æˆ–ã€å¼ å¼€ã€‘";
            document.getElementById('loading').style.opacity = '0';
            setTimeout(() => document.getElementById('loading').remove(), 800);

        } catch (err) {
            console.error("Camera Error: ", err);
            hint.innerHTML = "<span style='color: #ff4444'>æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æƒé™ã€‚</span>";
            document.getElementById('loading').style.display = 'none';
        }
    }

    function toggleEffect(explode) {
        isExploded = explode;
        const dummy = new THREE.Object3D();
        for (let i = 0; i < PARTICLE_COUNT; i++) {
            let tx, ty, tz;
            if (!explode) {
                const t = i / PARTICLE_COUNT;
                const r = (1 - t) * 8;
                tx = Math.cos(i * 0.4) * r; ty = t * 20 - 10; tz = Math.sin(i * 0.4) * r;
            } else {
                tx = (Math.random() - 0.5) * 50; ty = (Math.random() - 0.5) * 40; tz = (Math.random() - 0.5) * 50;
            }

            GSAP.to(dummy.position, {
                x: tx, y: ty, z: tz,
                duration: 1.5,
                ease: "expo.out",
                onUpdate: () => {
                    dummy.updateMatrix();
                    instMesh.setMatrixAt(i, dummy.matrix);
                    instMesh.instanceMatrix.needsUpdate = true;
                }
            });
        }
    }

    // --- æ¸²æŸ“å¾ªç¯ ---
    function animate() {
        requestAnimationFrame(animate);
        if(!isExploded) treeGroup.rotation.y += 0.005;
        snow.position.y -= 0.02;
        if(snow.position.y < -10) snow.position.y = 10;
        renderer.render(scene, camera);
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    // åŠ¨æ€è½½å…¥ä¾èµ–
    const loadScript = (src) => new Promise(res => {
        const s = document.createElement('script'); s.src = src; s.onload = res; document.head.appendChild(s);
    });

    Promise.all([
        loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'),
        loadScript('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js')
    ]).then(init);

</script>
</body>
</html>
