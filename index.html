<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Golden Glow - Merry Christmas</title>
    <style>
        :root { --gold: #D4AF37; --red: #B22222; }
        body { margin: 0; overflow: hidden; background: #000; font-family: "Georgia", serif; }
        
        /* æè‡´å¥¢åå¯åŠ¨é¡µ */
        #start-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(30px);
            padding: 4rem; border-radius: 2rem; border: 1px solid rgba(212, 175, 55, 0.15);
            text-align: center; box-shadow: 0 0 80px rgba(0,0,0,0.9);
        }
        .title { color: var(--gold); font-size: 3rem; letter-spacing: 12px; margin-bottom: 20px; font-weight: 200; text-shadow: 0 0 20px rgba(212,175,55,0.4); }
        
        .loader-wrap { width: 300px; margin: 30px 0; }
        .bar-bg { width: 100%; height: 1px; background: rgba(255,255,255,0.1); position: relative; }
        #bar-fill { width: 0%; height: 100%; background: var(--gold); position: absolute; transition: width 0.4s; box-shadow: 0 0 15px var(--gold); }
        
        #enter-btn {
            background: transparent; color: var(--gold); border: 1px solid var(--gold);
            padding: 12px 60px; font-size: 1rem; border-radius: 40px; cursor: pointer;
            opacity: 0.2; pointer-events: none; transition: all 0.5s;
        }
        #enter-btn.active { opacity: 1; pointer-events: auto; background: rgba(212,175,55,0.1); }
        #enter-btn:hover { background: var(--gold); color: #000; box-shadow: 0 0 30px var(--gold); }

        /* é¢„è§ˆä¸æç¤º */
        #video-box {
            position: absolute; top: 30px; right: 30px; width: 200px; height: 150px;
            border-radius: 12px; border: 1px solid rgba(212,175,55,0.3); overflow: hidden;
            transform: scaleX(-1); background: #000; z-index: 100;
        }
        .ui-hint {
            position: absolute; bottom: 40px; left: 40px; color: var(--gold);
            border-left: 2px solid var(--gold); padding-left: 20px; font-size: 14px; line-height: 2.2;
            letter-spacing: 1px; text-transform: uppercase;
        }
        .upload-btn {
            position: absolute; bottom: 40px; right: 40px; background: var(--red);
            color: #fff; padding: 12px 30px; border-radius: 30px; cursor: pointer; z-index: 200;
        }
    </style>
</head>
<body>

<div id="start-overlay">
    <div class="glass-card">
        <h1 class="title">THE GOLDEN GLOW</h1>
        <p style="color: #888; letter-spacing: 4px;">ç”µå½±çº§ AI æ‰‹åŠ¿äº¤äº’åœ£è¯æ ‘</p>
        <div class="loader-wrap">
            <div class="bar-bg"><div id="bar-fill"></div></div>
        </div>
        <button id="enter-btn">ENTER SPACE</button>
    </div>
</div>

<div id="container"></div>
<div id="video-box"><video id="input_video" playsinline muted></video></div>

<div class="ui-hint">
    Hold Fist âœŠ é‡æ„åœ£è¯ä¹‹æ ‘<br>
    Open Palm ğŸ–ï¸ æ•£è½æ¼«å¤©æ˜Ÿè¾°<br>
    Pinch Fingers ğŸ‘Œ èšç„¦çè´µç¬é—´<br>
    Move Hand ğŸ”„ æ—‹è½¬ç”µå½±è§†è§’
</div>

<label class="upload-btn" for="photo-file">ä¸Šä¼ ç…§ç‰‡äº‘</label>
<input type="file" id="photo-file" multiple accept="image/*" style="display:none">

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import TWEEN from 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@20.0.0/dist/tween.module.js';

    let scene, camera, renderer, composer, elements = [], photos = [];
    let currentState = 'CLOSED'; 
    let focusedPhoto = null;

    // 1. åˆå§‹åŒ–æè‡´åœºæ™¯
    function init() {
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(0x000000, 0.02);

        camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 22);

        renderer = new THREE.WebGLRenderer({ antialias: true, powerPreference: "high-performance" });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        renderer.toneMapping = THREE.ReinhardToneMapping;
        document.getElementById('container').appendChild(renderer.domElement);

        // ç¯å…‰ï¼šè¥é€ ç”µå½±æ„Ÿæ°›å›´
        const topLight = new THREE.SpotLight(0xffffff, 2);
        topLight.position.set(0, 20, 10);
        scene.add(topLight);
        scene.add(new THREE.AmbientLight(0xffffff, 0.2));

        // åæœŸåæœŸå¤„ç†ï¼šç’€ç’¨è¾‰å…‰
        const renderPass = new RenderPass(scene, camera);
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
        bloom.threshold = 0.15; bloom.strength = 1.4; bloom.radius = 1.0;
        
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloom);

        createStarsBackground();
        createTreeEntities();
        window.addEventListener('resize', onResize);
    }

    // èƒŒæ™¯æ˜Ÿç©º
    function createStarsBackground() {
        const starGeo = new THREE.BufferGeometry();
        const starPos = new Float32Array(2000 * 3);
        for(let i=0; i<6000; i++) starPos[i] = (Math.random()-0.5) * 100;
        starGeo.setAttribute('position', new THREE.BufferAttribute(starPos, 3));
        const starMat = new THREE.PointsMaterial({color: 0x444444, size: 0.1});
        scene.add(new THREE.Points(starGeo, starMat));
    }

    // 2. åˆ›å»ºå®ä½“åœ£è¯æ ‘ï¼ˆå“‘å…‰ç»¿ + é‡‘å±é‡‘ + åœ£è¯çº¢ï¼‰
    function createTreeEntities() {
        const geometries = [
            new THREE.SphereGeometry(0.12, 16, 16),
            new THREE.BoxGeometry(0.18, 0.18, 0.18),
            new THREE.CylinderGeometry(0.04, 0.04, 0.5)
        ];
        
        const materials = [
            new THREE.MeshStandardMaterial({ color: 0x1A3926, roughness: 0.9, metalness: 0.1 }), // å“‘å…‰ç»¿
            new THREE.MeshStandardMaterial({ color: 0xD4AF37, metalness: 1, roughness: 0.2 }), // é‡‘å±é‡‘
            new THREE.MeshStandardMaterial({ color: 0xB22222, metalness: 0.5, roughness: 0.5 }) // åœ£è¯çº¢
        ];

        for (let i = 0; i < 450; i++) {
            const mesh = new THREE.Mesh(geometries[i % 3], materials[i % 3]);
            const t = i / 450;
            const angle = t * Math.PI * 25;
            const radius = (1 - t) * 5.5;
            
            mesh.userData.closed = new THREE.Vector3(Math.cos(angle)*radius, t*13-6, Math.sin(angle)*radius);
            mesh.userData.scatter = new THREE.Vector3((Math.random()-0.5)*30, (Math.random()-0.5)*25, (Math.random()-0.5)*25);
            
            mesh.position.copy(mesh.userData.closed);
            mesh.rotation.set(Math.random()*Math.PI, Math.random()*Math.PI, 0);
            scene.add(mesh);
            elements.push(mesh);
        }
    }

    // 3. çŠ¶æ€åˆ‡æ¢
    function transform(nextState) {
        if(nextState === currentState) return;
        currentState = nextState;
        
        elements.forEach(el => {
            const target = (nextState === 'CLOSED') ? el.userData.closed : el.userData.scatter;
            new TWEEN.Tween(el.position).to({x: target.x, y: target.y, z: target.z}, 1500)
                .easing(TWEEN.Easing.Exponential.Out).start();
        });

        if(nextState !== 'FOCUS' && focusedPhoto) {
            new TWEEN.Tween(focusedPhoto.scale).to({x:1, y:1, z:1}, 1000).start();
            new TWEEN.Tween(focusedPhoto.position).to({z: focusedPhoto.userData.scatter.z}, 1000).start();
            focusedPhoto = null;
        }
    }

    // 4. ç…§ç‰‡ä¸Šä¼ 
    document.getElementById('photo-file').addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        files.forEach(file => {
            const url = URL.createObjectURL(file);
            new THREE.TextureLoader().load(url, tex => {
                const mesh = new THREE.Mesh(
                    new THREE.PlaneGeometry(3, 3), 
                    new THREE.MeshStandardMaterial({map: tex, side: THREE.DoubleSide, metalness: 0.2, roughness: 0.8})
                );
                mesh.userData.closed = new THREE.Vector3((Math.random()-0.5)*3, Math.random()*6, (Math.random()-0.5)*3);
                mesh.userData.scatter = new THREE.Vector3((Math.random()-0.5)*25, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
                mesh.position.copy(mesh.userData.closed);
                scene.add(mesh);
                photos.push(mesh);
                elements.push(mesh);
            });
        });
    });

    // 5. AI æ‰‹åŠ¿é€»è¾‘
    async function initAI() {
        const video = document.getElementById('input_video');
        const overlay = document.getElementById('start-overlay');
        
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await video.play();
            
            const hands = new window.Hands({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` });
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.75 });
            
            hands.onResults(res => {
                if(!res.multiHandLandmarks.length) return;
                const pts = res.multiHandLandmarks[0];
                
                const isFist = pts[8].y > pts[6].y && pts[12].y > pts[10].y;
                const isOpen = pts[8].y < pts[5].y && pts[20].y < pts[17].y;
                const pinch = Math.hypot(pts[8].x - pts[4].x, pts[8].y - pts[4].y) < 0.05;

                if(pinch && photos.length > 0) {
                    if(currentState !== 'FOCUS') {
                        transform('FOCUS');
                        focusedPhoto = photos[Math.floor(Math.random()*photos.length)];
                        new TWEEN.Tween(focusedPhoto.position).to({x:0, y:0, z:12}, 1000).easing(TWEEN.Easing.Back.Out).start();
                        new TWEEN.Tween(focusedPhoto.scale).to({x:2.5, y:2.5}, 1000).start();
                    }
                } else if(isFist) transform('CLOSED');
                else if(isOpen) transform('SCATTER');

                // è§†è§’è·Ÿéšæ‰‹éƒ¨åšç»†è…»åè½¬
                const targetX = (pts[0].x - 0.5) * -20;
                camera.position.x += (targetX - camera.position.x) * 0.05;
                camera.lookAt(0, 0, 0);
            });

            const cam = new window.Camera(video, { onFrame: async () => await hands.send({image: video}) });
            cam.start();

            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 1000);
        } catch (e) {
            alert("è¯·æˆäºˆæ‘„åƒå¤´æƒé™ã€‚å»ºè®®ä½¿ç”¨ Chrome æµè§ˆå™¨å¹¶ç¡®ä¿å¤„äº HTTPS ç¯å¢ƒã€‚");
        }
    }

    init();
    function animate(t) {
        requestAnimationFrame(animate);
        TWEEN.update(t);
        
        // è‡ªåŠ¨ç¼“æ…¢æ—‹è½¬
        const rotSpeed = currentState === 'CLOSED' ? 0.005 : 0.002;
        scene.rotation.y += rotSpeed;
        
        // å®ä½“å¾®åŠ¨åŠ¨ç”»
        elements.forEach((el, i) => {
            if(currentState === 'CLOSED') {
                el.position.y += Math.sin(t * 0.002 + i) * 0.002;
            }
        });

        composer.render();
    }
    animate();

    // èµ„æºé¢„åŠ è½½
    const loadJS = src => new Promise(res => { const s = document.createElement('script'); s.src = src; s.onload = res; document.head.append(s); });
    Promise.all([
        loadJS("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"),
        loadJS("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js")
    ]).then(() => {
        document.getElementById('bar-fill').style.width = '100%';
        const btn = document.getElementById('enter-btn');
        btn.classList.add('active');
        btn.onclick = initAI;
    });

    function onResize() {
        camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight); composer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
