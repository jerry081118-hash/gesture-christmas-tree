<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Golden Glow Christmas Tree - AI Vision</title>

<style>
body{margin:0;overflow:hidden;background:#000;font-family:"STSong","SimSun",serif;}
#container{width:100vw;height:100vh}

/* å¯åŠ¨é®ç½© */
#start-screen{
  position:fixed;inset:0;background:#000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:200;color:#D4AF37;
}
#start-screen button{
  margin-top:30px;
  padding:14px 40px;
  border-radius:40px;
  border:none;
  font-size:18px;
  background:linear-gradient(135deg,#ffe9a3,#d4af37);
  cursor:pointer;
}

/* æ‘„åƒå¤´ */
#video-container{
  position:absolute;top:20px;right:20px;
  width:180px;height:135px;
  border-radius:10px;overflow:hidden;
  border:2px solid rgba(212,175,55,.6);
  transform:scaleX(-1);z-index:10;
}
</style>
</head>

<body>

<div id="start-screen">
  <h2>ğŸ„ å¯åŠ¨åœ£è¯é­”æ³•</h2>
  <p>éœ€è¦æ‘„åƒå¤´æƒé™ä»¥è¯†åˆ«æ‰‹åŠ¿</p>
  <button id="start-btn">å¼€å¯æ‘„åƒå¤´</button>
</div>

<div id="container"></div>
<div id="video-container">
  <video id="input_video" autoplay muted playsinline></video>
</div>

<script type="importmap">
{
  "imports":{
    "three":"https://unpkg.com/three@0.158.0/build/three.module.js",
    "three/addons/":"https://unpkg.com/three@0.158.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import TWEEN from 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@20.0.0/dist/tween.module.js';

let scene,camera,renderer,composer,tree,star;
const COUNT=3000;
let state="CLOSED";

/* ---------- åœºæ™¯ ---------- */
initScene();
animate();

function initScene(){
  scene=new THREE.Scene();
  camera=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000);
  camera.position.set(0,1,12);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  document.getElementById("container").appendChild(renderer.domElement);

  composer=new EffectComposer(renderer);
  composer.addPass(new RenderPass(scene,camera));
  composer.addPass(new UnrealBloomPass(
    new THREE.Vector2(innerWidth,innerHeight),1.4,.4,.8
  ));

  createTree();
  createStar();
  window.addEventListener("resize",onResize);
}

/* ---------- æ ‘ ---------- */
function createTree(){
  const g=new THREE.BufferGeometry();
  const p=new Float32Array(COUNT*3);
  for(let i=0;i<COUNT;i++){
    const t=i/COUNT;
    const a=t*Math.PI*25;
    const r=(1-t)*4;
    p[i*3]=Math.cos(a)*r;
    p[i*3+1]=t*9-4.5;
    p[i*3+2]=Math.sin(a)*r;
  }
  g.setAttribute("position",new THREE.BufferAttribute(p,3));
  tree=new THREE.Points(g,new THREE.PointsMaterial({
    size:.08,color:0xD4AF37,transparent:true,opacity:.85
  }));
  scene.add(tree);
}

function createStar(){
  star=new THREE.Mesh(
    new THREE.IcosahedronGeometry(.4,0),
    new THREE.MeshBasicMaterial({color:0xffd700})
  );
  star.position.y=4.8;
  scene.add(star);
}

/* ---------- æ‰‹åŠ¿é€»è¾‘ ---------- */
async function startCameraAndAI(){
  const video=document.getElementById("input_video");

  // â‘  å¿…é¡»æ˜¾å¼è¯·æ±‚æƒé™
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{width:640,height:480}
  });
  video.srcObject=stream;
  await video.play();

  // â‘¡ MediaPipe Hands
  const hands=new window.Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  hands.setOptions({
    maxNumHands:1,
    minDetectionConfidence:.6,
    minTrackingConfidence:.6
  });

  hands.onResults(res=>{
    if(!res.multiHandLandmarks.length)return;
    const lm=res.multiHandLandmarks[0];
    const open=lm[8].y<lm[6].y;
    transform(open?"OPEN":"CLOSED");
  });

  // â‘¢ æ‰‹åŠ¨å¸§å¾ªç¯ï¼ˆé¿å… Camera ç±»é—®é¢˜ï¼‰
  async function loop(){
    await hands.send({image:video});
    requestAnimationFrame(loop);
  }
  loop();
}

/* ---------- å˜å½¢ ---------- */
function transform(mode){
  if(mode===state)return;
  state=mode;

  const arr=tree.geometry.attributes.position.array;
  for(let i=0;i<COUNT;i++){
    const t=i/COUNT;
    const target=(mode==="OPEN")
      ?{x:(Math.random()-.5)*20,y:(Math.random()-.5)*15,z:(Math.random()-.5)*20}
      :(()=>{
        const a=t*Math.PI*25,r=(1-t)*4;
        return {x:Math.cos(a)*r,y:t*9-4.5,z:Math.sin(a)*r};
      })();

    new TWEEN.Tween({
      x:arr[i*3],y:arr[i*3+1],z:arr[i*3+2]
    }).to(target,1200)
    .easing(TWEEN.Easing.Quadratic.Out)
    .onUpdate(o=>{
      arr[i*3]=o.x;arr[i*3+1]=o.y;arr[i*3+2]=o.z;
      tree.geometry.attributes.position.needsUpdate=true;
    }).start();
  }
}

/* ---------- åŠ¨ç”» ---------- */
function animate(t){
  requestAnimationFrame(animate);
  TWEEN.update(t);
  star.rotation.y+=.02;
  composer.render();
}

function onResize(){
  camera.aspect=innerWidth/innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(innerWidth,innerHeight);
  composer.setSize(innerWidth,innerHeight);
}

/* ---------- å¯åŠ¨æŒ‰é’® ---------- */
const load=s=>new Promise(r=>{
  const x=document.createElement("script");
  x.src=s;x.onload=r;document.head.appendChild(x);
});

Promise.all([
  load("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js")
]).then(()=>{
  document.getElementById("start-btn").onclick=async()=>{
    document.getElementById("start-screen").remove();
    await startCameraAndAI();
  };
});
</script>
</body>
</html>
