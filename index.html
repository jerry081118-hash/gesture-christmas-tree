<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>Merry Christmas âœ¨</title>

<style>
html,body{
  margin:0;
  background:#020409;
  overflow:hidden;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
}
#ui{
  position:fixed;
  top:20px;
  width:100%;
  text-align:center;
  color:#d4af37;
  z-index:10;
  pointer-events:none;
}
#ui h2{letter-spacing:4px;margin:0}
#ui p{opacity:.8;margin:6px 0}

#controls{
  position:fixed;
  left:20px;
  bottom:20px;
  z-index:20;
}
#controls button{
  display:block;
  margin-top:10px;
  padding:10px 18px;
  border-radius:20px;
  border:none;
  background:#d4af37;
  cursor:pointer;
}

#start{
  position:fixed;
  inset:0;
  background:#020409;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:100;
}
#start button{
  padding:18px 40px;
  font-size:18px;
  border-radius:40px;
  border:none;
  background:linear-gradient(135deg,#ffe9a3,#d4af37);
}

#video{
  position:fixed;
  right:20px;
  bottom:20px;
  width:140px;
  border-radius:10px;
  border:1px solid #d4af37;
  transform:scaleX(-1);
  opacity:.85;
  z-index:20;
}
</style>
</head>

<body>

<div id="ui">
  <h2>Merry Christmas</h2>
  <p id="hint">Raise your hand âœ‹</p>
</div>

<div id="controls">
  <button id="photoBtn">ðŸ“¸ ä¸Šä¼ ç…§ç‰‡</button>
</div>

<div id="start"><button>ðŸŽ„ Start Magic</button></div>

<input type="file" id="photoInput" accept="image/*" multiple hidden>
<video id="video" autoplay muted playsinline></video>

<audio id="music" loop>
  <source src="https://cdn.jsdelivr.net/gh/jerry081118/assets@main/christmas.mp3" type="audio/mpeg">
</audio>

<script type="importmap">
{
  "imports":{
    "three":"https://unpkg.com/three@0.160.0/build/three.module.js",
    "three/addons/":"https://unpkg.com/three@0.160.0/examples/jsm/"
  }
}
</script>

<script type="module">
import * as THREE from 'three';
import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
import { gsap } from 'https://cdn.skypack.dev/gsap';

let scene,camera,renderer,composer;
let tree,lights,star;
let ornaments=[];
let openness=0;

initScene();
animate();

/* ---------- åœºæ™¯ ---------- */
function initScene(){
  scene=new THREE.Scene();
  scene.fog=new THREE.Fog(0x020409,20,80);

  camera=new THREE.PerspectiveCamera(45,innerWidth/innerHeight,.1,200);
  camera.position.set(0,6,32);

  renderer=new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  document.body.appendChild(renderer.domElement);

  composer=new EffectComposer(renderer);
  composer.addPass(new RenderPass(scene,camera));
  composer.addPass(new UnrealBloomPass(
    new THREE.Vector2(innerWidth,innerHeight),
    1.6,.7,.15
  ));

  scene.add(new THREE.AmbientLight(0xffffff,.6));

  createTree();
  createLights();
  createStar();

  addEventListener('resize',()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
    composer.setSize(innerWidth,innerHeight);
  });
}

/* ---------- æ ‘ ---------- */
function createTree(){
  const g=new THREE.BufferGeometry(),p=[],c=[];
  for(let i=0;i<1600;i++){
    const t=Math.random(),r=(1-t)*7,a=Math.random()*Math.PI*2;
    p.push(Math.cos(a)*r,t*18-9,Math.sin(a)*r);
    c.push(.2+.2*Math.random(),.6+.3*Math.random(),.2);
  }
  g.setAttribute('position',new THREE.Float32BufferAttribute(p,3));
  g.setAttribute('color',new THREE.Float32BufferAttribute(c,3));
  tree=new THREE.Points(g,new THREE.PointsMaterial({
    size:.18,vertexColors:true,transparent:true,opacity:.9
  }));
  scene.add(tree);
}

function createLights(){
  const g=new THREE.BufferGeometry(),p=[];
  for(let i=0;i<220;i++){
    const t=Math.random(),r=(1-t)*6.5,a=Math.random()*Math.PI*2;
    p.push(Math.cos(a)*r,t*16-8,Math.sin(a)*r);
  }
  g.setAttribute('position',new THREE.Float32BufferAttribute(p,3));
  lights=new THREE.Points(g,new THREE.PointsMaterial({
    color:0xffd87a,size:.28,transparent:true
  }));
  scene.add(lights);
}

function createStar(){
  star=new THREE.Mesh(
    new THREE.IcosahedronGeometry(.8,1),
    new THREE.MeshBasicMaterial({color:0xfff1b0})
  );
  star.position.y=9.8;
  scene.add(star);
}

/* ---------- ç…§ç‰‡è£…é¥° ---------- */
document.getElementById('photoBtn').onclick=()=>{
  document.getElementById('photoInput').click();
};

document.getElementById('photoInput').onchange=e=>{
  [...e.target.files].forEach(file=>{
    const url=URL.createObjectURL(file);
    const tex=new THREE.TextureLoader().load(url);
    const mat=new THREE.SpriteMaterial({map:tex});
    const s=new THREE.Sprite(mat);

    const t=Math.random(),r=(1-t)*6.2,a=Math.random()*Math.PI*2;
    s.position.set(Math.cos(a)*r,t*16-8,Math.sin(a)*r);
    s.scale.set(2,2,1);

    scene.add(s);
    ornaments.push(s);
  });
};

/* ---------- æ‰‹åŠ¿ ---------- */
async function initHand(){
  const hint=document.getElementById('hint');
  const video=document.getElementById('video');
  const music=document.getElementById('music');
  music.volume=0; music.play();

  const hands=new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });
  hands.setOptions({maxNumHands:1});
  hands.onResults(r=>{
    if(!r.multiHandLandmarks)return;
    const lm=r.multiHandLandmarks[0];
    const open=lm[8].y<lm[6].y && lm[12].y<lm[10].y;

    gsap.to({v:openness},{
      v:open?1:0,duration:1,
      onUpdate(){openness=this.targets()[0].v;}
    });

    gsap.to(music,{volume:open?.6:.25,duration:1});
    hint.innerText=open?"âœ¨ Magic On":"ðŸŽ„ Hold";
  });

  const cam=new Camera(video,{
    onFrame:async()=>hands.send({image:video}),
    width:640,height:480
  });
  await cam.start();
}

/* ---------- åŠ¨ç”» ---------- */
function animate(t=0){
  requestAnimationFrame(animate);
  tree.scale.set(1+openness*.35,1+openness*.2,1+openness*.35);
  tree.rotation.y+=.002;
  lights.material.opacity=.6+Math.sin(t*.002)*.3;
  star.scale.setScalar(1+Math.sin(t*.003)*.15);
  star.rotation.y+=.01;
  ornaments.forEach(o=>o.material.opacity=.7+openness*.3);
  composer.render();
}

/* ---------- å¯åŠ¨ ---------- */
const load=s=>new Promise(r=>{
  const x=document.createElement('script');
  x.src=s;x.onload=r;document.head.appendChild(x);
});
Promise.all([
  load('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'),
  load('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js')
]).then(()=>{
  document.querySelector('#start button').onclick=()=>{
    document.getElementById('start').remove();
    initHand();
  };
});
</script>
</body>
</html>
