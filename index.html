<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Golden Glow - Merry Christmas</title>
    <style>
        :root { --gold: #D4AF37; --red: #B22222; }
        body { margin: 0; overflow: hidden; background: #000; font-family: "Georgia", serif; touch-action: none; }
        
        /* å¯åŠ¨é¡µ */
        #start-overlay {
            position: fixed; inset: 0; z-index: 1000;
            background: radial-gradient(circle at center, #1a1a1a 0%, #000 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 1s ease;
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.02); backdrop-filter: blur(30px);
            padding: 2rem; border-radius: 2rem; border: 1px solid rgba(212, 175, 55, 0.15);
            text-align: center; width: 80%; max-width: 400px;
        }
        .title { color: var(--gold); font-size: 2rem; letter-spacing: 6px; margin-bottom: 10px; font-weight: 200; }
        
        .loader-wrap { width: 100%; margin: 30px 0; }
        .bar-bg { width: 100%; height: 1px; background: rgba(255,255,255,0.1); position: relative; }
        #bar-fill { width: 0%; height: 100%; background: var(--gold); position: absolute; transition: width 0.4s; box-shadow: 0 0 15px var(--gold); }
        
        #enter-btn {
            background: transparent; color: var(--gold); border: 1px solid var(--gold);
            padding: 12px 40px; font-size: 1rem; border-radius: 40px; cursor: pointer;
            opacity: 0.3; pointer-events: none; transition: all 0.5s;
        }
        #enter-btn.active { opacity: 1; pointer-events: auto; }

        /* è§†é¢‘é¢„è§ˆæ¡† - ç§»åŠ¨ç«¯é€‚é… */
        #video-box {
            position: absolute; top: 20px; right: 20px; width: 120px; height: 90px;
            border-radius: 8px; border: 1px solid rgba(212, 175, 55, 0.3); overflow: hidden;
            transform: scaleX(-1); background: #000; z-index: 100;
        }
        #input_video { width: 100%; height: 100%; object-fit: cover; }

        .ui-hint {
            position: absolute; bottom: 20px; left: 20px; color: var(--gold);
            font-size: 10px; line-height: 1.8; letter-spacing: 1px; pointer-events: none;
        }
    </style>
</head>
<body>

<div id="start-overlay">
    <div class="glass-card">
        <h1 class="title">THE GOLDEN GLOW</h1>
        <p style="color: #888; font-size: 12px; letter-spacing: 2px;">ç”µå½±çº§ AI æ‰‹åŠ¿äº¤äº’åœ£è¯æ ‘</p>
        <div class="loader-wrap">
            <div class="bar-bg"><div id="bar-fill"></div></div>
        </div>
        <button id="enter-btn">ç­‰å¾…èµ„æºåŠ è½½...</button>
    </div>
</div>

<div id="container"></div>
<div id="video-box"><video id="input_video" playsinline muted autoplay></video></div>

<div class="ui-hint">
    âœŠ é‡æ„ / ğŸ–ï¸ æ•£è½ / ğŸ‘Œ èšç„¦ / ğŸ”„ æ—‹è½¬è§†è§’
</div>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.158.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.158.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import TWEEN from 'https://cdn.jsdelivr.net/npm/@tweenjs/tween.js@20.0.0/dist/tween.module.js';

    let scene, camera, renderer, composer, elements = [], photos = [];
    let currentState = 'CLOSED'; 
    let focusedPhoto = null;

    // --- åˆå§‹åŒ– 3D åœºæ™¯ (ä¿æŒä½ çš„é€»è¾‘) ---
    function init() {
        scene = new THREE.Scene();
        camera = new THREE.PerspectiveCamera(50, window.innerWidth/window.innerHeight, 0.1, 1000);
        camera.position.set(0, 2, 22);

        renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);

        const renderPass = new RenderPass(scene, camera);
        const bloom = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.4, 0.85);
        composer = new EffectComposer(renderer);
        composer.addPass(renderPass);
        composer.addPass(bloom);

        createTreeEntities();
        window.addEventListener('resize', onResize);
    }

    function createTreeEntities() {
        const geo = new THREE.SphereGeometry(0.1, 8, 8);
        const mat = new THREE.MeshStandardMaterial({ color: 0xD4AF37 });
        for (let i = 0; i < 300; i++) {
            const mesh = new THREE.Mesh(geo, mat);
            const t = i / 300;
            const angle = t * Math.PI * 20;
            const radius = (1 - t) * 5;
            mesh.userData.closed = new THREE.Vector3(Math.cos(angle)*radius, t*12-6, Math.sin(angle)*radius);
            mesh.userData.scatter = new THREE.Vector3((Math.random()-0.5)*20, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
            mesh.position.copy(mesh.userData.closed);
            scene.add(mesh);
            elements.push(mesh);
        }
        scene.add(new THREE.AmbientLight(0xffffff, 0.5));
    }

    function transform(state) {
        if(state === currentState) return;
        currentState = state;
        elements.forEach(el => {
            const target = (state === 'CLOSED') ? el.userData.closed : el.userData.scatter;
            new TWEEN.Tween(el.position).to({x:target.x, y:target.y, z:target.z}, 1000).start();
        });
    }

    // --- æ ¸å¿ƒä¼˜åŒ–ï¼šAI ä¸ æ‘„åƒå¤´æƒé™ ---
    async function initAI() {
        const video = document.getElementById('input_video');
        const btn = document.getElementById('enter-btn');
        const overlay = document.getElementById('start-overlay');

        btn.innerText = "æ­£åœ¨ç”³è¯·æ‘„åƒå¤´...";
        
        try {
            // 1. ç«‹å³è¯·æ±‚æƒé™ (å¿…é¡»åœ¨ç‚¹å‡»å›è°ƒçš„æœ€é¡¶å±‚)
            const stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user" }, 
                audio: false 
            });
            video.srcObject = stream;
            // iOS å¼ºåˆ¶è¦æ±‚ play() åœ¨ç‚¹å‡»äº‹ä»¶å†…è§¦å‘
            await video.play();

            btn.innerText = "å¯åŠ¨ AI æ¨¡å‹...";

            // 2. åˆå§‹åŒ– MediaPipe
            const hands = new window.Hands({ 
                locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}` 
            });
            hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.7, modelComplexity: 1 });

            hands.onResults(res => {
                if(!res.multiHandLandmarks.length) return;
                const pts = res.multiHandLandmarks[0];
                const isFist = pts[8].y > pts[6].y && pts[12].y > pts[10].y;
                const isOpen = pts[8].y < pts[5].y && pts[20].y < pts[17].y;
                
                if(isFist) transform('CLOSED');
                else if(isOpen) transform('SCATTER');

                // è§†è§’è·Ÿéš
                camera.position.x += ((pts[0].x - 0.5) * -15 - camera.position.x) * 0.05;
                camera.lookAt(0, 0, 0);
            });

            const cam = new window.Camera(video, {
                onFrame: async () => { await hands.send({image: video}); },
                width: 480, height: 360
            });
            await cam.start();

            // è¿›å…¥åœºæ™¯
            overlay.style.opacity = '0';
            setTimeout(() => overlay.remove(), 1000);

        } catch (err) {
            console.error(err);
            alert("æ‘„åƒå¤´å¼€å¯å¤±è´¥ï¼è¯·ç¡®ä¿ï¼š\n1. ä½¿ç”¨ HTTPS è®¿é—®\n2. å·²æˆäºˆæµè§ˆå™¨æ‘„åƒå¤´æƒé™\n3. å»ºè®®ä½¿ç”¨ Safari æˆ– Chrome");
            btn.innerText = "é‡è¯• ENTER SPACE";
        }
    }

    // èµ„æºé¢„åŠ è½½å¤„ç†
    const loadJS = src => new Promise(res => { 
        const s = document.createElement('script'); 
        s.src = src; s.onload = res; 
        s.onerror = () => alert("è„šæœ¬åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ");
        document.head.append(s); 
    });

    init();
    function animate(t) {
        requestAnimationFrame(animate);
        TWEEN.update(t);
        scene.rotation.y += 0.002;
        composer.render();
    }
    animate();

    // ç¡®ä¿åº“åŠ è½½åå†æ¿€æ´»æŒ‰é’®
    Promise.all([
        loadJS("https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"),
        loadJS("https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js")
    ]).then(() => {
        document.getElementById('bar-fill').style.width = '100%';
        const btn = document.getElementById('enter-btn');
        btn.innerText = "ENTER SPACE";
        btn.classList.add('active');
        btn.onclick = initAI; // ç»‘å®šç‚¹å‡»äº‹ä»¶
    });

    function onResize() {
        camera.aspect = window.innerWidth/window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }
</script>
</body>
</html>
