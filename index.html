<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<title>Golden Christmas Tree Â· AI Vision</title>

<style>
body{margin:0;overflow:hidden;background:#000;font-family:-apple-system,BlinkMacSystemFont}
#container{width:100vw;height:100vh}

/* å¯åŠ¨å±‚ */
#start-screen{
  position:fixed;inset:0;
  background:#000;
  display:flex;flex-direction:column;
  align-items:center;justify-content:center;
  z-index:200;color:#D4AF37;
}
#start-screen button{
  margin-top:24px;
  padding:14px 40px;
  border-radius:40px;
  border:none;
  font-size:18px;
  cursor:pointer;
  background:linear-gradient(135deg,#ffe9a3,#d4af37);
}

/* ç¯å¢ƒæç¤º */
#env-tip{
  position:fixed;inset:0;
  background:rgba(0,0,0,.88);
  color:#D4AF37;
  display:none;
  align-items:center;
  justify-content:center;
  text-align:center;
  z-index:300;
  padding:40px;
}
#env-tip button{
  margin-top:20px;
  padding:10px 30px;
  border-radius:30px;
  border:none;
}

/* æ‘„åƒå¤´é¢„è§ˆ */
#video-box{
  position:absolute;
  top:16px;right:16px;
  width:160px;height:120px;
  border-radius:10px;
  overflow:hidden;
  border:2px solid rgba(212,175,55,.6);
  transform:scaleX(-1);
  z-index:10;
}
#video-box video{width:100%;height:100%;object-fit:cover}
</style>
</head>

<body>

<div id="start-screen">
  <h2>ğŸ„ Golden Christmas Tree</h2>
  <p>ç”µè„‘æµè§ˆå™¨æ”¯æŒ AI æ‰‹åŠ¿äº¤äº’</p>
  <button id="start-btn">å¼€å§‹ä½“éªŒ</button>
</div>

<div id="env-tip">
  <div>
    <h2>ğŸ æ¸©é¦¨æç¤º</h2>
    <p id="env-text"></p>
    <button onclick="this.closest('#env-tip').style.display='none'">æˆ‘çŸ¥é“äº†</button>
  </div>
</div>

<div id="container"></div>
<div id="video-box"><video id="video" playsinline muted></video></div>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.158.0/build/three.module.js";
import { Hands } from "https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js";

/* ========= ç¯å¢ƒåˆ¤æ–­ ========= */
const isWeChat = () => /micromessenger/i.test(navigator.userAgent);
const isMobile = () => /iphone|ipad|android/i.test(navigator.userAgent);

/* ========= Three.js ========= */
let scene,camera,renderer,tree;
const COUNT = 2200;
let exploded = false;

initScene();
animate();

function initScene(){
  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60,innerWidth/innerHeight,0.1,100);
  camera.position.z = 12;

  renderer = new THREE.WebGLRenderer({antialias:true});
  renderer.setSize(innerWidth,innerHeight);
  renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  document.getElementById("container").appendChild(renderer.domElement);

  const geo = new THREE.BufferGeometry();
  const pos = new Float32Array(COUNT*3);

  for(let i=0;i<COUNT;i++){
    const t=i/COUNT;
    const a=t*Math.PI*22;
    const r=(1-t)*4;
    pos[i*3]=Math.cos(a)*r;
    pos[i*3+1]=t*8-4;
    pos[i*3+2]=Math.sin(a)*r;
  }

  geo.setAttribute("position",new THREE.BufferAttribute(pos,3));
  tree = new THREE.Points(
    geo,
    new THREE.PointsMaterial({
      size:0.08,
      color:0xD4AF37,
      transparent:true,
      opacity:0.85
    })
  );
  scene.add(tree);

  addEventListener("resize",()=>{
    camera.aspect=innerWidth/innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(innerWidth,innerHeight);
  });
}

/* ========= åŠ¨ç”» ========= */
function animate(){
  requestAnimationFrame(animate);
  tree.rotation.y += exploded ? 0.01 : 0.003;
  renderer.render(scene,camera);
}

/* ========= æ‰‹åŠ¿ ========= */
async function startAI(){
  const video = document.getElementById("video");

  const stream = await navigator.mediaDevices.getUserMedia({video:true});
  video.srcObject = stream;
  await video.play();

  const hands = new Hands({
    locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
  });

  hands.setOptions({
    maxNumHands:1,
    minDetectionConfidence:0.6,
    minTrackingConfidence:0.6
  });

  hands.onResults(res=>{
    if(!res.multiHandLandmarks.length) return;
    const lm = res.multiHandLandmarks[0];
    exploded = lm[8].y < lm[6].y; // å¼ å¼€ / æ¡æ‹³
  });

  async function loop(){
    await hands.send({image:video});
    requestAnimationFrame(loop);
  }
  loop();
}

/* ========= UI ========= */
const startBtn = document.getElementById("start-btn");
startBtn.onclick = async ()=>{
  if(isWeChat()){
    showTip("å¾®ä¿¡å†…æ— æ³•è°ƒç”¨æ‘„åƒå¤´ï¼Œè¯·ç‚¹å‡»å³ä¸Šè§’åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ã€‚");
    return;
  }
  if(isMobile()){
    showTip("æ‰‹æœºç«¯ä¸ºè§‚èµæ¨¡å¼ï¼Œå»ºè®®ä½¿ç”¨ç”µè„‘æµè§ˆå™¨ä½“éªŒ AI æ‰‹åŠ¿ã€‚");
    return;
  }
  document.getElementById("start-screen").remove();
  await startAI();
};

function showTip(text){
  document.getElementById("env-text").innerText = text;
  document.getElementById("env-tip").style.display="flex";
}
</script>
</body>
</html>
