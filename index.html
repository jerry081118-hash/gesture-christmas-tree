<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>Golden Christmas Magic - Vivid Edition</title>
    <style>
        body { margin: 0; background: #0a1a2f; overflow: hidden; font-family: 'Segoe UI', sans-serif; }
        #loading-screen { position: fixed; inset: 0; background: radial-gradient(circle, #1a3a5f, #050a0f); display: flex; align-items: center; justify-content: center; z-index: 1000; color: gold; font-size: 1.2rem; letter-spacing: 2px; }
        #video-overlay { position: fixed; bottom: 20px; right: 20px; width: 180px; height: 135px; border: 2px solid gold; border-radius: 15px; transform: scaleX(-1); z-index: 100; box-shadow: 0 0 20px rgba(255,215,0,0.3); }
        .ui-panel { position: fixed; top: 40px; left: 0; width: 100%; text-align: center; color: white; pointer-events: none; z-index: 10; }
        h1 { margin: 0; font-weight: 300; background: linear-gradient(to bottom, #ffffff, #d4af37); -webkit-background-clip: text; -webkit-text-fill-color: transparent; filter: drop-shadow(0 0 10px rgba(255,215,0,0.5)); }
        #upload-btn { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: gold; color: #800; padding: 12px 30px; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; z-index: 200; box-shadow: 0 5px 20px rgba(0,0,0,0.4); transition: 0.3s; }
        #upload-btn:hover { transform: translateX(-50%) scale(1.1); background: #fff; }
    </style>
</head>
<body>

<div id="loading-screen">âœ¨ æ­£åœ¨ç‚¹äº®åœ£è¯æ£®æ—...</div>

<div class="ui-panel">
    <h1>GOLDEN CHRISTMAS 2025</h1>
    <p id="status">ğŸ‘‹ è¯·å¼€å¯æ‘„åƒå¤´ï¼Œå°è¯•ã€æ¡æ‹³ã€‘æˆ–ã€å¼ å¼€æ‰‹æŒã€‘</p>
</div>

<button id="upload-btn" onclick="document.getElementById('file-input').click()">â• æ·»åŠ è®°å¿†ç…§ç‰‡</button>
<input type="file" id="file-input" hidden multiple accept="image/*">
<video id="v-src" playsinline style="display:none"></video>

<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
</script>

<script type="module">
    import * as THREE from 'three';
    import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
    import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
    import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
    import { GSAP } from 'https://cdn.skypack.dev/gsap';

    let scene, camera, renderer, composer, treeGroup, particles, snow;
    let isExploded = false;
    const photos = [];

    // --- åœºæ™¯åˆå§‹åŒ– ---
    async function init() {
        scene = new THREE.Scene();
        // è®¾ç½®æ˜äº®çš„èƒŒæ™¯è‰²è°ƒ
        scene.background = new THREE.Color(0x05101a);
        scene.fog = new THREE.FogExp2(0x05101a, 0.015);

        camera = new THREE.PerspectiveCamera(40, window.innerWidth / window.innerHeight, 1, 1000);
        camera.position.set(0, 8, 35);

        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        renderer.toneMapping = THREE.ACESFilmicToneMapping;
        renderer.toneMappingExposure = 1.2;
        document.body.appendChild(renderer.domElement);

        // è¾‰å…‰è®¾ç½® - è°ƒäº®é˜ˆå€¼
        const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.0, 0.3, 0.7);
        composer = new EffectComposer(renderer);
        composer.addPass(new RenderPass(scene, camera));
        composer.addPass(bloomPass);

        // å…‰æºæå‡
        const sunLight = new THREE.DirectionalLight(0xffffff, 2);
        sunLight.position.set(5, 20, 10);
        scene.add(sunLight);
        scene.add(new THREE.AmbientLight(0x406080, 0.8)); // å¢åŠ è“è‰²è°ƒç¯å¢ƒå…‰

        createVividTree();
        createSnow();
        setupHands();
        animate();

        document.getElementById('loading-screen').style.display = 'none';
    }

    // --- æ„å»ºå…·è±¡åœ£è¯æ ‘ ---
    function createVividTree() {
        treeGroup = new THREE.Group();
        const count = 1200; // å¢åŠ ç²’å­å¯†åº¦
        const geometry = new THREE.IcosahedronGeometry(0.15, 1);
        
        const matGold = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 1, roughness: 0.2, emissive: 0xffaa00, emissiveIntensity: 0.2 });
        const matRed = new THREE.MeshStandardMaterial({ color: 0xff2200, metalness: 0.7, roughness: 0.1 });
        const matGreen = new THREE.MeshStandardMaterial({ color: 0x11ff44, metalness: 0.5, roughness: 0.5 });

        const iMesh = new THREE.InstancedMesh(geometry, matGold, count);
        const dummy = new THREE.Object3D();
        const color = new THREE.Color();

        for (let i = 0; i < count; i++) {
            // é‡‡ç”¨æ–æ³¢é‚£å¥‘èºæ—‹ç®—æ³•æ’åˆ—ï¼Œä½¿å½¢çŠ¶æ›´åƒçœŸå®çš„æ ‘
            const t = i / count;
            const a = i * 0.2 + (Math.PI * 2 * t);
            const r = (1 - t) * 8; // åº•éƒ¨å®½ï¼Œé¡¶éƒ¨çª„
            const y = t * 20 - 10;

            dummy.position.set(Math.cos(a) * r, y, Math.sin(a) * r);
            dummy.scale.setScalar(Math.random() * 0.8 + 0.4);
            dummy.updateMatrix();
            iMesh.setMatrixAt(i, dummy.matrix);

            // é¢œè‰²åˆ†å¸ƒ
            if (i % 10 === 0) color.set(0xff0000); // çº¢è‰²è£…é¥°çƒ
            else if (i % 5 === 0) color.set(0xffffff); // ç™½è‰²é—ªå…‰çƒ
            else color.set(0x1a4a1a); // æ ‘æœ¨åº•è‰²
            iMesh.setColorAt(i, color);
        }

        treeGroup.add(iMesh);
        scene.add(treeGroup);
        particles = iMesh;

        // æ ‘é¡¶æ˜Ÿ
        const starGeom = new THREE.SphereGeometry(1.2, 16, 16);
        const starMat = new THREE.MeshBasicMaterial({ color: 0xffffcc });
        const star = new THREE.Mesh(starGeom, starMat);
        star.position.y = 11;
        treeGroup.add(star);
    }

    // --- èƒŒæ™¯é›ªèŠ±ç²’å­ ---
    function createSnow() {
        const snowGeom = new THREE.BufferGeometry();
        const snowPos = [];
        for(let i=0; i<2000; i++) {
            snowPos.push((Math.random()-0.5)*100, Math.random()*50, (Math.random()-0.5)*100);
        }
        snowGeom.setAttribute('position', new THREE.Float32BufferAttribute(snowPos, 3));
        const snowMat = new THREE.PointsMaterial({ color: 0xffffff, size: 0.1, transparent: true, opacity: 0.8 });
        snow = new THREE.Points(snowGeom, snowMat);
        scene.add(snow);
    }

    // --- æ‰‹åŠ¿äº¤äº’ (MediaPipe) ---
    async function setupHands() {
        const hands = new Hands({locateFile: (f) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`});
        hands.setOptions({ maxNumHands: 1, minDetectionConfidence: 0.8 });
        
        const video = document.getElementById('v-src');
        hands.onResults(results => {
            if (results.multiHandLandmarks && results.multiHandLandmarks[0]) {
                const lm = results.multiHandLandmarks[0];
                const tip = lm[8]; // é£ŸæŒ‡
                const wrist = lm[0]; // æ‰‹è…•
                const dist = Math.hypot(tip.x - wrist.x, tip.y - wrist.y);

                if (dist < 0.2 && isExploded) toggleState(false);
                else if (dist > 0.4 && !isExploded) toggleState(true);

                // è§†è§’è·Ÿéš
                gsap.to(camera.position, {
                    x: (lm[9].x - 0.5) * 50,
                    y: -(lm[9].y - 0.5) * 30 + 8,
                    duration: 0.6
                });
                camera.lookAt(0, 0, 0);
            }
        });

        const cameraFeed = new Camera(video, {
            onFrame: async () => { await hands.send({image: video}); },
            width: 640, height: 480
        });
        cameraFeed.start();
    }

    function toggleState(explode) {
        isExploded = explode;
        document.getElementById('status').innerText = explode ? "âœ¨ å¹»å¢ƒå¼€å¯ âœ¨" : "ğŸ„ åœ£è¯å½’ä½ ğŸ„";
        
        const dummy = new THREE.Object3D();
        for (let i = 0; i < 1200; i++) {
            let tx, ty, tz;
            if (!explode) {
                const t = i / 1200;
                const a = i * 0.2 + (Math.PI * 2 * t);
                const r = (1 - t) * 8;
                tx = Math.cos(a) * r; ty = t * 20 - 10; tz = Math.sin(a) * r;
            } else {
                tx = (Math.random() - 0.5) * 60; ty = (Math.random() - 0.5) * 40; tz = (Math.random() - 0.5) * 60;
            }

            gsap.to(dummy.position, {
                x: tx, y: ty, z: tz,
                duration: 2,
                ease: "elastic.out(1, 0.75)",
                onUpdate: () => {
                    dummy.updateMatrix();
                    particles.setMatrixAt(i, dummy.matrix);
                    particles.instanceMatrix.needsUpdate = true;
                }
            });
        }
    }

    // --- ç…§ç‰‡äº‘ ---
    document.getElementById('file-input').onchange = (e) => {
        Array.from(e.target.files).forEach(file => {
            const url = URL.createObjectURL(file);
            const tex = new THREE.TextureLoader().load(url);
            const card = new THREE.Mesh(
                new THREE.PlaneGeometry(4, 3),
                new THREE.MeshStandardMaterial({ map: tex, side: THREE.DoubleSide, emissive: 0xffffff, emissiveIntensity: 0.3 })
            );
            card.position.set((Math.random()-0.5)*40, (Math.random()-0.5)*30, (Math.random()-0.5)*40);
            scene.add(card);
            photos.push(card);
        });
    };

    function animate() {
        requestAnimationFrame(animate);
        if(!isExploded) treeGroup.rotation.y += 0.005;
        
        // é›ªèŠ±ä¸‹è½
        snow.position.y -= 0.05;
        if(snow.position.y < -20) snow.position.y = 20;

        composer.render();
    }

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // è½½å…¥ä¾èµ–å¹¶å¯åŠ¨
    const loadLib = (u) => new Promise(r => { const s = document.createElement('script'); s.src = u; s.onload = r; document.head.appendChild(s); });
    Promise.all([
        loadLib('https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js'),
        loadLib('https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js')
    ]).then(init);

</script>
</body>
</html>
